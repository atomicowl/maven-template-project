#!/bin/sh

# =========================================================================
# PRE-PUSH HOOK
#
# Purpose: Prevent broken code from reaching protected branches.
# Strategy: Run full verification (tests + quality checks) only on key branches.
# =========================================================================

echo "üöÄ Running pre-push hook..."

# 1. READ INPUT
# The pre-push hook receives input on stdin in the format:
# <local_ref> <local_oid> <remote_ref> <remote_oid>
# We only care about the remote_ref (where we are pushing TO).

protected_branch='0'

while read local_ref local_oid remote_ref remote_oid; do
    # Extract the branch name (e.g., refs/heads/main -> main)
    target_branch=$(echo "$remote_ref" | sed 's|refs/heads/||')

    echo "   Target Branch: $target_branch"

    # Check if this is a protected branch
    case "$target_branch" in
        main|master|develop|release/*)
            protected_branch='1'
            ;;
    esac
done

# 2. DECIDE: TO RUN OR NOT TO RUN
if [ "$protected_branch" = "0" ]; then
    echo "‚úÖ Pushing to non-protected branch. Skipping heavy tests."
    exit 0
fi

echo "üõ°Ô∏è  Protected branch detected. Running full verification suite..."

# 3. RUN VERIFICATION (Unit Tests, Integration Tests, Linting)
# Uses 'just verify' if available, falls back to 'mvn verify'
if command -v just >/dev/null 2>&1; then
    just test
else
    ./mvnw test
fi

# 4. HANDLE RESULT
exit_code=$?

if [ $exit_code -ne 0 ]; then
    echo ""
    echo "‚ùå PUSH REJECTED: Tests or Quality Checks failed."
    echo "   Please fix the issues above and try again."
    echo "   (Emergency bypass: git push --no-verify)"
    echo ""
    exit 1
fi

echo "‚úÖ All checks passed. Pushing code..."
exit 0
